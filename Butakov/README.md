Скоро запонлю
## Введение (описать задание)

В рамках практики было предложено позаниматься разработкой RAG решения для ответа на вопросы по нормативным документам ИБ.

Для старта был предоставлен QA по нормативке, который содержит вопросы и ответы от экспертов по теме ККИ. https://187.ussc.ru/faq/

## Гипотеза: Подход RAG может помочь создать Ассистента для ИБ аналитика.

В функции, которые будет выполнять такой ассистент на даном этапе мы закладываем

1. Предобработка/доступ к базе нормативных документов
2. Поиск релевантной информации по запросу пользователя
3. Генерация ответа на основе найденного контекста

В ходе этого отчёта мы затронем первые две темы.

## Постановка задачи(ПостФактум)

Основные задачи, которые я решал в рамках практики стали:

1. Создание бенчмарка для оценки качества ретривера на уровне документов
(Не фрагментов).
2. Создание синтетического датасета
3. Дообучение embedding модели e5

Код и прочее представлено здесь:

[USS-ChatOps/Butakov at main · qqushka/USS-ChatOps](https://github.com/qqushka/USS-ChatOps/tree/main/Butakov)

## Методология

### Создание бенчмарка для ретривера

Для создания бенчмарка использовались предоставленные [QA](https://187.ussc.ru/faq/) данные. Бенчмарк позволяет оценивать качество ретривера, сопоставляя документы, которые упоминаются в ответах QA, с документами, найденными с помощью ретривера.

Датасет документов :https://drive.google.com/drive/folders/1D1rzOQW3WOgHPmistoPyVRQIf5nVFWwU?usp=sharing (32)

Датасет по ссылке https://docs.google.com/spreadsheets/d/1mH1uL-2Nee-lGUO7ZE_Fh989PSGO-Jvw/edit?usp=sharing&ouid=115870898929369537939&rtpof=true&sd=true (115)

Пример:

| Question | Answer | Links | Link Titles | PDF Title |
| --- | --- | --- | --- | --- |
| New!СБ ЗОКИИ: какие ограничения существуют по допуску иностранного гражданина к эксплуатации или обслуживанию значимого объекта КИИ? | Ответ: прямые ограничения по допуску иностранных граждан к эксплуатации и обслуживанию значимого объекта критической информационной инфраструктуры (далее – КИИ) не установлены в …… | http://pravo.gov.ru/proxy/ips/?docbody=&nd=102149573&rdk=&backlink=1, https://minjust.consultant.ru/documents/1036?items=100, http://publication.pravo.gov.ru/Document/View/0001202207140018 | Федерального закона от 21.07.2011 № 256-ФЗ «О безопасности объектов топливно-энергетического комплекса», приказом Министерства энергетики РФ от 13.12.2011 № 587, Федерального закона от 14.07.2022 № 255-ФЗ «О контроле за деятельностью лиц, находящихся под иностранным влиянием» | 18) Приказ Минэнерго РФ от 13.12.2011 № 587 _Об утверждении перечня работ, непосредственно связанных с о.pdf, 37) Федеральный закон от 14.07.2022 № 255-ФЗ (ред. от 15.05.2024) _О контроле за деятельностью лиц, нахо.pdf |

Embed Model: [intfloat/multilingual-e5-large](https://huggingface.co/intfloat/multilingual-e5-large)

Результаты Бенчмарка при взятии **Top 3** ближайших документов из векторной БД.

```
-------------------------------------------------------------------
Total True Positives: 74
Total False Positives: 149
Average Precision: 0.41
Average Recall: 0.51
Average F1 Score: 0.42
-------------------------------------------------------------------
```

### Дообучение embedding модели e5

Для улучшения качества ретривера была дообучена модель e5 с использованием функции потерь [MultipleNegativesRankingLoss](https://sbert.net/examples/training/ms_marco/README.html?highlight=multiplenegativesrankingloss#multiplenegativesrankingloss). 

Она использует триплеты: `(query, positive_passage, negative_passage)` где `positive_passage` - релевантный фрагмент запроса и `negative_passage` - нерелевантный фрагмент запроса. Мы вычисляем вложения для всех запросов, положительных и отрицательных пассажей в корпусе, а затем оптимизируем следующую цель

### Создание синтетического датасета

Для дообучения модели требовался датасет, состоящий из столбцов `query`/`positive_passage`/`negative_passage`. В нашем случае мы имели только положительный корпус, который является чанком из нормативного документа. Было принято решение создать синтетический датасет с использованием GPT-4o mini. 

Логика следующая: на вход модели подается позитивный чанк, и к нему придумывается вопрос. Для негативного примера создается неправильный ответ, похожий по структуре на релевантный.

```python
question
f"""Прочитайте следующий текст и задайте к нему вопрос. В вопросах ты не должен ссылаться напрямую на текст.
 Задвай вопрос так, как будто у тебя нет контекста: {text[:500]}"""}

negative
f"""Напиши одно предложение, которое будут является противоположным относительно
 Пример:{text[:500]}. Оно должно иметь стиль текста, как в примере, но при этом не быть похожим с ним. Старайся, чтобы некст визуально значительно отличался. Пиши сразу ответы без нумерации и чего то ещё лишнего. 
"""}
```

Всего было сгенерировано 6000 синтетических примеров

[val_dataset.json](https://prod-files-secure.s3.us-west-2.amazonaws.com/b49b92aa-e5f6-4c00-bdba-ebd853de4fd3/d68fb5ca-a1a8-4ab3-9716-c0dc7bf34f0f/val_dataset.json)

```json
    {
        "anchor": "Каковы основные функции федерального органа, отвечающего за контроль в сфере информационных технологий и связи?",
        "positive": "инициалы (для физического лица) или наименование (для юридического лица); 6) установить одну из предлагаемых федеральным органом исполнительной власти, осуществляющим функции по контролю и надзору в сфере средств массовой информации, массовых коммуникаций, информационных технологий и связи, предназначенных для определения количества пользователей информационным ресурсом в сети \"Интернет\" программ для электронных вычислительных машин; 7) обеспечить интеграцию и взаимодействие сервиса размещения объявлений с единой системой идентификации и аутентификации и федеральной государственной информационной системой \"Единый портал государственных и муниципальных услуг (функций)\" в случаях и порядке, которые устанавливаются Правительством Российской Федерации.",
        "negative": "отказаться от использования любых предложенных федеральным органом исполнительной власти, осуществляющим функции по контролю и надзору в сфере средств массовой информации, массовых коммуникаций, информационных технологий и связи, программ для электронных вычислительных машин, предназначенных для определения количества пользователей информационным ресурсом в сети \"Интернет\"; не обеспечивать интеграцию и взаимодействие сервиса размещения о."
    },
    {
        "anchor": "Каковы фактические доли доверенных программноаппаратных комплексов в общем количестве используемых комплексов в критической информационной инфраструктуре?",
        "positive": "содержащим данные по типам программноаппаратных комплексов. <4> Указываются фактические доли доверенных программноаппаратных комплексов в общем количестве программноаппаратных комплексов, применяемых субъектом критической информационной инфраструктуры на принадлежащих ему значимых объектах критической информационной инфраструктуры, по состоянию на отчетную дату для каждого типа программноаппаратных комплексов и для позиции \"Итого по всем типам программноаппаратных комплексов\", которые определяются как отношение фактических значений количества доверенных программноаппаратных комплексов к общему количеству программноаппаратных комплексов по соответствующим позициям.",
        "negative": "Не указываются доли недоверенных программноаппаратных комплексов в общем количестве программноаппаратных комплексов, используемых субъектом критической информационной инфраструктуры на не принадлежащих ему объектах критической информационной инфраструктуры, по состоянию на отчетную дату для каждого типа программноаппаратных комплексов и для позиции \"Итого по всем типам программноаппаратных комплексов\", которые не определяют."
    }
```

### Оценка результатов

Файнтюн **intfloat/multilingual-e5-large** требует больших вычистельных ресурсов, поэтому замеры проходили на модели в разы меньше **intfloat/multilingual-e5-small**

Замер обычного **intfloat/multilingual-e5-small**

```
-------------------------------------------------------------------
Total True Positives: 46
Total False Positives: 185
Average Precision: 0.20
Average Recall: 0.32
Average F1 Score: 0.23
-------------------------------------------------------------------
```

Замер **fine-tune** **intfloat/multilingual-e5-small**

```
-------------------------------------------------------------------
Total True Positives: 57
Total False Positives: 203
Average Precision: 0.24
Average Recall: 0.37
Average F1 Score: 0.27
-------------------------------------------------------------------
```

Учитывая такие недостатки, как не такой большой размер датасета, наличие исправимых шумов и доработки промтинга — Можно сказать, что результат 👍🏻

## Точки роста)

1. Я считаю, что в основе построение хороших RAG(LLM) решений лежит то, чтобы хорошо проработать предметную область, в частности попытаться воссоздать процесс, который проходит специалист при попытке решить определенную задачу. Например, если речь про юриста отвечающего на какой то вопрос, то важно отследить, как он прорабатывает вопрос, о чём в первую очередь думает и почему принимает такие мысленные решения - куда в первую очередь посмотреть и т.п. Такие вещи могут стать хорошими подсказками при построении RAG решения. (В каком то смысле проработать  продуктовую сторону, не пытаясь сделать волшебную палочку)
2. Предобработка информации: Грамотная реализация чанкинга текста, возможное применение графовых методов. Использования методик построение карты знаний(Речь не про графы).  
3. Улучшение синтетического датасета.
4. Проба других методик продвинутого рага.
5. Много что ещё
